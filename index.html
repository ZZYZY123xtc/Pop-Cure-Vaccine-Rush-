<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>萌菌研究所 - 培养皿守护战</title>
    
    <!-- 🚀 性能优化：预连接Google Fonts，减少延迟 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- 🎨 可选字体：加载失败不影响游戏运行 -->
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 🎯 Stage 容器：所有层的统一参照系 -->
    <div id="stage">
        
        <!-- ============================================================
             开始屏幕层
             ============================================================ -->
        <div id="start-layer" class="stage-layer">
            <div class="tutorial-card">
                <div class="logo-area">🔬</div>
                <h1>萌菌研究所</h1>
                <p class="subtitle">实习研究员，欢迎入职！</p>
                
                <div class="rules-container">
                    <div class="rule-item">
                        <span class="icon">👆</span>
                        <div class="text">
                            <h3>点击消除</h3>
                            <p>点击果冻病毒来收集数据</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <span class="icon">🧪</span>
                        <div class="text">
                            <h3>充满治愈条</h3>
                            <p>顶部进度条满 <span class="highlight">100%</span> 即可过关</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <span class="icon">⚠️</span>
                        <div class="text">
                            <h3>小心感染</h3>
                            <p>底部感染条满了就会 <span class="danger">任务失败</span></p>
                        </div>
                    </div>
                </div>
                <button id="start-btn">开始实验</button>
            </div>
        </div>
        
        <!-- ============================================================
             地图层
             ============================================================ -->
        <div id="map-layer" class="stage-layer hidden">
            <canvas id="map-canvas"></canvas>
            <div id="energy-bar">
                <span class="icon">⚡</span>
                <span id="energy-text">30/30</span>
            </div>
        </div>
        
        <!-- ============================================================
             故事层
             ============================================================ -->
        <div id="story-layer" class="stage-layer hidden">
            <canvas id="story-canvas"></canvas>
            
            <!-- 浮动对话框 -->
            <div class="story-dialog">
                <div class="story-header">
                    <div class="story-avatar">🤖</div>
                    <h2 id="story-title">系统启动中...</h2>
                </div>
                <div class="story-text-box">
                    <div id="story-text" class="story-text"></div>
                </div>
                <div class="story-controls">
                    <button id="story-next-btn" class="story-btn next">继续 ▶</button>
                </div>
            </div>
        </div>
        
        <!-- ============================================================
             游戏层
             ============================================================ -->
        <div id="game-layer" class="stage-layer hidden">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <!-- ============================================================
             UI 层（游戏 HUD）
             ============================================================ -->
        <div id="ui-layer" class="stage-layer hidden">
            <div id="game-container">
                <div id="ui-header">
                    <div class="header-left">
                        <div class="level-display">
                            <span id="level-display-header">Level 1</span> / <span id="total-levels-header">5</span>
                        </div>
                        <!-- 被动技能显示区域 -->
                        <div id="passive-skill-area" class="hidden">
                            <div class="combo-display">
                                <span class="lightning-icon">⚡</span>
                                <span class="combo-text">Combo: <span id="combo-count">0</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="header-center">
                        <h1 id="game-title">培养皿守护战</h1>
                    </div>
                    <div class="header-right">
                        <button id="audio-toggle-btn" class="icon-btn" title="静音" aria-label="静音切换" aria-pressed="false">🎵</button>
                        <button id="pause-btn" class="icon-btn" title="游戏设置">⚙️</button>
                    </div>
                    <div class="progress-box" id="vaccine-progress">
                        <div class="progress-label">疫苗研发进度</div>
                        <div class="progress-bar-wrapper">
                            <div id="cure-bar-header" class="progress-bar cure"></div>
                        </div>
                    </div>
                </div>

                <!-- 技能区 (右下角，默认隐藏) -->
                <div id="skill-container" class="hidden">
                    <div id="active-skill-btn" class="skill-btn locked hidden">
                        <div class="skill-icon">❄️</div>
                        <div class="cooldown-overlay"></div>
                        <!-- 🔥 数字移到skill-btn的直接子元素，不受overlay高度限制 -->
                        <span class="cd-number"></span>
                        <div class="key-hint">极寒</div>
                    </div>
                </div>

                <!-- Footer 区域 (10vh) -->
                <div id="ui-footer">
                    <div class="progress-box">
                        <div class="progress-label">免疫系统负荷</div>
                        <div class="progress-bar-wrapper">
                            <div id="infection-bar-footer" class="progress-bar infection"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ============================================================
             模态框层
             ============================================================ -->
        <div id="modal-layer" class="stage-layer">
        <!-- 第25关：奶油浮窗（确认后开战） -->
        <div id="final-boss-briefing" class="modal-overlay hidden">
            <div class="final-boss-briefing-card">
                <h2>[第25关：终焉主脑 · 奶油坍塌]</h2>

                <p>🍦 点击剥落奶油壳，残渣飞出时必须拦截！</p>
                <p>⚠️ 残渣逃逸 <span class="gold-number">1</span> 个，免疫负荷 <span class="gold-number">+5</span>（满 <span class="gold-number">100</span> 失败）。</p>
                <p>✨ 奶油球 &lt; <span class="gold-number">15</span> 后停止喷发，专心拆迁。</p>
                <p>👑 奶油球 &lt; <span class="gold-number">5</span> 暴露核心，<span class="gold-number">10秒</span>内疯狂连点 <span class="gold-number">100</span> 下！</p>

                <button id="final-boss-briefing-btn">开启圣战</button>
            </div>
        </div>

        <div id="game-over" class="hidden">
            <div class="modal-content">
                <h2>防守失败!</h2>
                <p>小病毒们把这里占领了...</p>
                <button id="game-over-back-btn">返回地图</button>
            </div>
        </div>
        
        <!-- 关卡胜利弹窗 (绿色系) -->
        <div id="level-complete" class="hidden">
            <div class="modal-content">
                <h2>🌟 关卡完成! 🌟</h2>
                <p>小病毒都被消灭啦！</p>
                <div class="score-summary">
                    治愈率: <span class="highlight">100%</span>
                </div>
                <button id="next-level-btn">前往下一关 ➔</button>
            </div>
        </div>
        
        <!-- 胜利弹窗 -->
        <div id="game-win" class="hidden">
            <div class="modal-content">
                <h2>防守成功!</h2>
                <p>成功清除所有危险病毒!</p>
                <button onclick="location.reload()">下一关</button>
            </div>
        </div>
        
        <!-- 游戏设置菜单弹窗 -->
        <div id="pause-menu" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>⚙️ 游戏设置</h2>
                <p>选择继续战斗或返回地图重新规划</p>
                <button id="resume-game-btn" class="primary-btn">继续游戏</button>
                <button id="pause-back-to-map-btn" class="secondary-btn">返回地图</button>
            </div>
        </div>

        <!-- 图鉴弹窗 (Enhanced) -->
        <div id="intro-modal" class="modal-overlay hidden">
            <div class="intro-card">
                <div class="card-header">
                    <span>🔬 机密档案</span>
                    <span class="badge">NEW</span>
                </div>
                
                <!-- 动态预览区 -->
                <div class="canvas-wrapper">
                    <canvas id="intro-canvas" width="120" height="120"></canvas>
                </div>
                
                <h2 id="intro-name">病毒名称</h2>
                <p id="intro-desc">病毒描述文案...</p>
                
                <!-- 数据面板 -->
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-label">生命值</span>
                        <div id="intro-hp" class="hp-display">❤️</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">危险度</span>
                        <div id="intro-danger" class="danger-stars">⭐</div>
                    </div>
                </div>
                
                <!-- 弱点高亮 -->
                <div class="weakness-box">
                    <strong>🎯 弱点分析：</strong>
                    <p id="intro-weakness" class="weakness-text">弱点描述...</p>
                </div>
                
                <!-- 机制教学 -->
                <div class="tutorial-box">
                    <div class="icon-ring">⭕</div>
                    <div class="text">
                        <strong>繁殖机制</strong><br>
                        <span>圈圈跑完前消灭它，否则会分裂！</span>
                    </div>
                </div>
                
                <button id="intro-start-btn">开始净化</button>
            </div>
        </div>

        <!-- 技能解锁弹窗 -->
        <div id="skill-unlock-modal" class="modal-overlay hidden">
            <div class="skill-unlock-card">
                <div class="unlock-header">
                    <h2>🎉 新科技研发完成 🎉</h2>
                </div>
                
                <!-- 技能图标 -->
                <div class="skill-icon-large" id="unlock-skill-icon">🧊</div>
                
                <!-- 技能名称 -->
                <h3 id="unlock-skill-name">极寒领域</h3>
                
                <!-- 技能参数面板 -->
                <div class="skill-params">
                    <div class="param-item">
                        <span class="param-label">类型</span>
                        <span id="unlock-skill-type" class="param-value">主动技</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">冷却</span>
                        <span id="unlock-skill-cd" class="param-value">45秒</span>
                    </div>
                </div>
                
                <!-- 技能动画演示 -->
                <div class="skill-demo-area">
                    <canvas id="skill-demo-canvas" width="280" height="140"></canvas>
                    <div class="demo-label">⚡ 技能演示</div>
                </div>
                
                <!-- 技能描述 -->
                <div class="skill-desc-box">
                    <p id="unlock-skill-desc">点击右下角按钮，冻结全屏病毒 5 秒。停止移动和分裂。</p>
                </div>
                
                <button id="equip-skill-btn">装备技能 ✓</button>
            </div>
        </div>

        <!-- 🧪 Toast提示系统（萌萌的关卡提示） -->
        <div id="level-tip-toast" class="level-tip-toast hidden">
            <div class="toast-icon">🧪</div>
            <div class="toast-content">
                <div class="toast-title" id="toast-title">提示标题</div>
                <div class="toast-text" id="toast-text">提示内容</div>
            </div>
        </div>

        <!-- 教学引导气泡系统（内容由 JS 动态填充） -->
        <div id="tutorial-overlay" class="hidden">
            <!-- 步骤 1 -->
            <div class="guide-bubble step-1 hidden" data-step="1">
                <div class="bubble-content">
                    <h3></h3>
                    <p></p>
                    <p class="tip"></p>
                    <button class="next-guide-btn" onclick="nextGuide()">知道了 →</button>
                </div>
            </div>

            <!-- 步骤 2 -->
            <div class="guide-bubble step-2 hidden" data-step="2">
                <div class="bubble-content">
                    <h3></h3>
                    <p></p>
                    <p class="tip"></p>
                    <button class="next-guide-btn" onclick="nextGuide()">明白了 →</button>
                </div>
            </div>

            <!-- 步骤 3 -->
            <div class="guide-bubble step-3 hidden" data-step="3">
                <div class="bubble-content">
                    <h3></h3>
                    <p></p>
                    <p class="tip"></p>
                    <button class="next-guide-btn" onclick="nextGuide()">我记住了 →</button>
                </div>
            </div>

            <!-- 步骤 4 -->
            <div class="guide-bubble step-4 hidden" data-step="4">
                <div class="bubble-content">
                    <h3></h3>
                    <p></p>
                    <p class="tip"></p>
                    <button class="next-guide-btn" onclick="endGuide()">开始游戏！</button>
                </div>
            </div>
        </div>
        </div>
        
    </div> <!-- #stage 结束 -->

    <script type="module">
        // 导入核心模块
        import { startGame, init } from './js/core/game.js';
        import { SceneManager } from './js/managers/scene-manager.js';
        import { viewportManager, setCanvasSizeUpdateCallback } from './js/systems/viewport-manager.js';
        import { layerManager } from './js/systems/layer-manager.js';
        import { markCanvasSizeNeedsUpdate } from './js/systems/game-loop.js';

        console.log('[INIT] 开始初始化游戏...');
        
        // ✅ 设置性能优化回调：通知游戏循环更新缓存
        setCanvasSizeUpdateCallback(markCanvasSizeNeedsUpdate);
        
        // 🎯 初始化 ViewportManager 并注册所有 Canvas
        window.viewportManager = viewportManager;
        window.layerManager = layerManager;
        
        // 注册地图 Canvas
        viewportManager.registerCanvas('map-canvas', (width, height, dpr) => {
            console.log(`[ViewportManager] 地图 Canvas 已调整: ${width}x${height} (DPR: ${dpr})`);
            // 地图渲染器会监听这个回调并重新绘制
            if (window.sceneManager && window.sceneManager.mapRenderer) {
                window.sceneManager.mapRenderer.resize(width, height, dpr);
            }
        });
        
        // 注册游戏 Canvas（只使用75%的viewport高度，留出header和footer）
        viewportManager.registerCanvas('gameCanvas', (width, height, dpr) => {
            console.log(`[ViewportManager] 游戏 Canvas 已调整: ${width}x${height} (DPR: ${dpr})`);
            // ✅ ViewportManager 已自动设置 canvas.width/height 和 DPR 缩放
            // 游戏渲染由 game-loop 持续进行，无需额外操作
        }, { heightFactor: 0.75 });  // ✅ 只使用75%的viewport高度
        
        // 注册故事 Canvas
        viewportManager.registerCanvas('story-canvas', (width, height, dpr) => {
            console.log(`[ViewportManager] 故事 Canvas 已调整: ${width}x${height} (DPR: ${dpr})`);
            // ✅ ViewportManager 已自动设置 canvas.width/height 和 DPR 缩放
            // 故事场景渲染由其自己的循环处理
        });
        
        console.log('[ViewportManager] 所有 Canvas 已注册');
        
        // 🎯 初始化层显示状态
        layerManager.goToStart();  // 显示开始屏幕

        // 初始化游戏（设置事件监听、UI 初始化）
        try {
            init();
            console.log('[INIT] 游戏壳初始化成功');
        } catch (err) {
            console.error('[INIT ERROR] 游戏初始化失败:', err);
        }

        // 全局监听地图场景事件（提前注册，避免时序问题）
        window.addEventListener('sceneManagerEnterLevel', (e) => {
            const { levelId } = e.detail;
            console.log('[GAME] 收到进入关卡事件, levelId =', levelId);
            startGame(levelId);
        });

        // 在开始按钮点击时，会先播放开场动画
        // 动画完成后触发 startButtonClicked 事件，此时才初始化 SceneManager
        let sceneManagerInitialized = false;

        window.addEventListener('startButtonClicked', () => {
            console.log('[EVENT] startButtonClicked 触发（开场动画已完成）');
            
            // 切换到地图层
            layerManager.goToMap();
            
            if (!sceneManagerInitialized) {
                try {
                    console.log('[SCENE] 初始化场景管理器...');
                    window.sceneManager = new SceneManager();
                    sceneManagerInitialized = true;
                    console.log('[SCENE] 场景管理器初始化成功, playerState =', window.sceneManager.getPlayerState());
                } catch (err) {
                    console.error('[SCENE ERROR] 场景管理器初始化失败:', err);
                    console.error(err.stack);
                }
            }
        });
    </script>
</body>
</html>
